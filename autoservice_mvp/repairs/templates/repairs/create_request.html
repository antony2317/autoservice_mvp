{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'repairs/css/create_request.css' %}">
{% endblock %}

{% block content %}
<div class="repair-form-container">
  <div class="repair-form-card">
    <div class="form-header">
      <h3>Новая заявка на ремонт</h3>
    </div>
    <div class="form-body">
      {% if user_cars|length == 0 %}
        <div style="text-align: center; margin-top: 1rem;">
          <p>У вас пока нет добавленных автомобилей.</p>
          <a href="{% url 'add_car' %}" class="btn btn-primary">Добавить автомобиль</a>
        </div>
      {% else %}
        <form method="post" id="repairForm" action="{% url 'repairs:create_request' %}">
          {% csrf_token %}

          {% if user_cars|length > 1 %}
            <div class="form-group" id="car-group">
              <label for="{{ form.car.id_for_label }}">Автомобиль</label>
              {{ form.car }}
            </div>
          {% else %}
            {{ form.car.as_hidden }}
            <p class="form-group"><strong>Автомобиль:</strong> {{ user_cars.0 }}</p>
          {% endif %}

          <div class="form-group" id="category-group">
            <label for="{{ form.category.id_for_label }}">Категория ремонта</label>
            {{ form.category }}
          </div>

          <div class="form-group" id="repair-type-container">
            <label for="{{ form.repair_type.id_for_label }}">Тип ремонта</label>
            {{ form.repair_type }}
          </div>

          <label class="checkbox-container">
            <input type="checkbox" id="problem_not_listed" name="problem_not_listed" {% if form.problem_not_listed.value %}checked{% endif %}>
            <span class="custom-checkbox"></span>
            <span>Моей проблемы нет в списке</span>
          </label>

          <div class="form-group" id="description-group">
            <label for="{{ form.description.id_for_label }}">Комментарий</label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="error-message">{{ form.description.errors }}</div>
            {% endif %}
          </div>

          <button type="submit" class="submit-button">Отправить заявку</button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const categoryField = document.getElementById('id_category');
  const typeField = document.getElementById('id_repair_type');
  const typeContainer = document.getElementById('repair-type-container');
  const categoryGroup = document.getElementById('category-group');
  const descriptionField = document.getElementById('id_description');
  const descriptionGroup = document.getElementById('description-group');
  const problemNotListedCheckbox = document.getElementById('problem_not_listed');
  const repairForm = document.getElementById('repairForm');

  // Изначально деактивируем поле Тип ремонта
  typeField.disabled = true;

  // Функция для плавного скрытия элемента
  function smoothHide(element) {
    element.style.overflow = 'hidden';
    element.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    element.style.height = element.offsetHeight + 'px';
    element.style.marginBottom = window.getComputedStyle(element).marginBottom;

    requestAnimationFrame(() => {
      element.style.height = '0';
      element.style.marginTop = '0';
      element.style.marginBottom = '0';
      element.style.paddingTop = '0';
      element.style.paddingBottom = '0';
      element.style.opacity = '0';
      element.style.transform = 'scaleY(0)';
    });
  }

  // Функция для плавного показа элемента
  function smoothShow(element) {
    element.style.display = '';
    element.style.overflow = 'hidden';
    element.style.height = '0';
    element.style.opacity = '0';
    element.style.transform = 'scaleY(0)';

    const originalStyles = {
      height: element.scrollHeight + 'px',
      opacity: '1',
      transform: 'scaleY(1)',
      marginTop: window.getComputedStyle(element).marginTop,
      marginBottom: window.getComputedStyle(element).marginBottom,
      paddingTop: window.getComputedStyle(element).paddingTop,
      paddingBottom: window.getComputedStyle(element).paddingBottom
    };

    requestAnimationFrame(() => {
      Object.assign(element.style, originalStyles);

      setTimeout(() => {
        element.style.overflow = '';
        element.style.height = '';
      }, 500);
    });
  }

  categoryField.addEventListener('change', function () {
    if (problemNotListedCheckbox.checked) return;

    const categoryId = this.value;

    if (!categoryId) {
      typeField.innerHTML = '<option value="">Выберите категорию</option>';
      typeField.disabled = true;
      return;
    }

    fetch("{% url 'repairs:ajax_load_types' %}?category=" + categoryId)
      .then(response => response.json())
      .then(data => {
        typeField.innerHTML = '<option value="">Выберите тип ремонта</option>';
        data.types.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.name;
          typeField.appendChild(option);
        });
        typeField.disabled = false;
      })
      .catch(error => console.error('Error:', error));
  });

  problemNotListedCheckbox.addEventListener('change', function() {
    if (this.checked) {
      smoothHide(typeContainer);
      smoothHide(categoryGroup);
      descriptionGroup.classList.add('description-highlight');
      descriptionField.placeholder = 'Пожалуйста, опишите проблему подробно...';
      descriptionField.required = true;
    } else {
      smoothShow(typeContainer);
      smoothShow(categoryGroup);
      descriptionGroup.classList.remove('description-highlight');
      descriptionField.placeholder = '';
      descriptionField.required = false;

      if (categoryField.value) {
        const event = new Event('change');
        categoryField.dispatchEvent(event);
      }
    }
  });

  // Инициализация при загрузке, если чекбокс уже отмечен
  if (problemNotListedCheckbox.checked) {
    typeContainer.style.display = 'none';
    categoryGroup.style.display = 'none';
    typeField.disabled = true;
    categoryField.disabled = true;
    descriptionGroup.classList.add('description-highlight');
    descriptionField.placeholder = 'Пожалуйста, опишите проблему подробно...';
    descriptionField.required = true;
  }

  // Обработка отправки формы
  repairForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(repairForm);

    fetch(repairForm.action, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.redirect_url;
      } else {
        // Обработка ошибок валидации
        if (data.errors) {
          // Здесь можно добавить отображение ошибок в форме
          console.error('Form errors:', data.errors);
          alert('Пожалуйста, заполните все обязательные поля правильно.');
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Произошла ошибка при отправке формы. Пожалуйста, попробуйте снова.');
    });
  });
});
</script>
{% endblock %}